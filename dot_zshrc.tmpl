# ------------------------------
# History
# ------------------------------
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt SHARE_HISTORY          # share history across sessions
setopt HIST_IGNORE_ALL_DUPS   # don't record duplicates
setopt HIST_REDUCE_BLANKS     # remove superfluous blanks
setopt HIST_VERIFY            # show expanded history before executing

# ------------------------------
# Completion
# ------------------------------
autoload -Uz compinit
compinit

zstyle ':completion:*' menu select                     # interactive menu
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'   # case-insensitive match
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}" # coloured completions

# ------------------------------
# Shell options
# ------------------------------
setopt AUTO_CD           # cd by typing directory name
setopt CORRECT           # offer correction for mistyped commands
setopt INTERACTIVE_COMMENTS  # allow comments in interactive shell

# ------------------------------
# Editor
# ------------------------------
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
fi

# ------------------------------
# Aliases
# ------------------------------
alias vim="nvim"

# git (subset of oh-my-zsh git plugin)
alias g="git"
alias ga="git add"
alias gaa="git add --all"
alias gc="git commit"
alias gcm="git commit -m"
alias gco="git checkout"
alias gd="git diff"
alias gds="git diff --staged"
alias gl="git pull"
alias glog="git log --oneline --decorate --graph"
alias gp="git push"
alias grb="git rebase"
alias gst="git status"
alias gsw="git switch"
alias gswc="git switch -c"

# ------------------------------
# Environment
# ------------------------------
export PATH="$HOME/bin:$PATH"
export ERL_AFLAGS="-kernel shell_history enabled"

# ------------------------------
# Plugins
# ------------------------------
{{- if eq .chezmoi.os "darwin" }}
source $(brew --prefix)/share/zsh-you-should-use/you-should-use.plugin.zsh
source $(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh
source $(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
{{- else }}
# Source plugins from standard Linux paths (apt: /usr/share, pacman: /usr/share/zsh/plugins)
for plugin_dir in /usr/share/zsh-you-should-use /usr/share/zsh/plugins/zsh-you-should-use; do
  [[ -f "$plugin_dir/you-should-use.plugin.zsh" ]] && source "$plugin_dir/you-should-use.plugin.zsh" && break
done
for plugin_dir in /usr/share/zsh-autosuggestions /usr/share/zsh/plugins/zsh-autosuggestions; do
  [[ -f "$plugin_dir/zsh-autosuggestions.zsh" ]] && source "$plugin_dir/zsh-autosuggestions.zsh" && break
done
for plugin_dir in /usr/share/zsh-syntax-highlighting /usr/share/zsh/plugins/zsh-syntax-highlighting; do
  [[ -f "$plugin_dir/zsh-syntax-highlighting.zsh" ]] && source "$plugin_dir/zsh-syntax-highlighting.zsh" && break
done
{{- end }}

# ------------------------------
# Prompt (robbyrussell-style)
# ------------------------------
autoload -Uz vcs_info
precmd() { vcs_info }
zstyle ':vcs_info:git:*' formats ' %F{red}(%b)%f'
setopt PROMPT_SUBST
PROMPT='%(?:%F{green}➜:%F{red}➜)%f %F{cyan}%c%f${vcs_info_msg_0_} '

# ------------------------------
# Tool integrations
# ------------------------------
eval "$(mise activate zsh)"
eval "$(direnv hook zsh)"
eval "$(zoxide init zsh)"
eval "$(chezmoi completion zsh)"
command -v op &>/dev/null && eval "$(op completion zsh)" && compdef _op op
